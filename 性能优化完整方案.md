# MoneyPrinterTurbo æ€§èƒ½ä¼˜åŒ–å®Œæ•´æ–¹æ¡ˆ

## ğŸ“Š å½“å‰æ€§èƒ½åˆ†æ

### ä¸»è¦æ€§èƒ½ç“¶é¢ˆ
1. **è§†é¢‘ç¼–ç **ï¼šå ç”¨80-90%çš„æ—¶é—´ï¼ˆCPUè½¯ç¼–ç ï¼‰
2. **å­—å¹•æ¸²æŸ“**ï¼šç‰¹åˆ«æ˜¯è¿½åŠ æ˜¾ç¤ºæ¨¡å¼ï¼Œéœ€è¦æ¸²æŸ“å¤§é‡clip
3. **å›¾ç‰‡å¤„ç†**ï¼šé¢„å¤„ç†é˜¶æ®µçš„å›¾ç‰‡è½¬è§†é¢‘
4. **éŸ³é¢‘åˆæˆ**ï¼šèƒŒæ™¯éŸ³ä¹æ··åˆ
5. **çº¿ç¨‹æ•°é‡**ï¼šå½“å‰é»˜è®¤åªä½¿ç”¨2ä¸ªçº¿ç¨‹

---

## ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

### æ–¹æ¡ˆ1ï¼šå¯ç”¨GPUåŠ é€Ÿç¼–ç  â­â­â­â­â­ï¼ˆæ¨èï¼‰

**æ€§èƒ½æå‡**ï¼š60-80%åŠ é€Ÿ

**åŸç†**ï¼šä½¿ç”¨ç¡¬ä»¶ç¼–ç å™¨æ›¿ä»£CPUè½¯ç¼–ç 

#### macOSï¼ˆæ”¯æŒM1/M2/M3èŠ¯ç‰‡ï¼‰

```python
# ä½¿ç”¨ VideoToolbox ç¡¬ä»¶åŠ é€Ÿï¼ˆè‹¹æœèŠ¯ç‰‡åŸç”Ÿæ”¯æŒï¼‰
ffmpeg_params = [
    '-c:v', 'h264_videotoolbox',  # ä½¿ç”¨ç¡¬ä»¶ç¼–ç å™¨
    '-b:v', '5M',                  # æ¯”ç‰¹ç‡5Mbps
    '-allow_sw', '1',              # å¦‚æœç¡¬ä»¶ä¸å¯ç”¨ï¼Œå…è®¸å›é€€åˆ°è½¯ä»¶ç¼–ç 
    '-movflags', '+faststart',
]
```

#### Windows/Linuxï¼ˆNVIDIA GPUï¼‰

```python
# ä½¿ç”¨ NVENC ç¡¬ä»¶åŠ é€Ÿ
ffmpeg_params = [
    '-c:v', 'h264_nvenc',          # NVIDIAç¡¬ä»¶ç¼–ç å™¨
    '-preset', 'p4',               # å¿«é€Ÿé¢„è®¾ï¼ˆp1æœ€å¿«ï¼Œp7æœ€æ…¢ï¼‰
    '-b:v', '5M',
    '-movflags', '+faststart',
]
```

#### Windows/Linuxï¼ˆAMD GPUï¼‰

```python
# ä½¿ç”¨ AMF ç¡¬ä»¶åŠ é€Ÿ
ffmpeg_params = [
    '-c:v', 'h264_amf',            # AMDç¡¬ä»¶ç¼–ç å™¨
    '-quality', 'speed',           # é€Ÿåº¦ä¼˜å…ˆ
    '-b:v', '5M',
    '-movflags', '+faststart',
]
```

#### Intel GPUï¼ˆé›†æˆæ˜¾å¡ï¼‰

```python
# ä½¿ç”¨ QSV ç¡¬ä»¶åŠ é€Ÿ
ffmpeg_params = [
    '-c:v', 'h264_qsv',            # Intel Quick Sync Video
    '-preset', 'veryfast',
    '-b:v', '5M',
    '-movflags', '+faststart',
]
```

---

### æ–¹æ¡ˆ2ï¼šå¢åŠ çº¿ç¨‹æ•° â­â­â­â­

**æ€§èƒ½æå‡**ï¼š20-40%åŠ é€Ÿ

**å½“å‰é…ç½®**ï¼š`threads=2`ï¼ˆå¤ªå°‘äº†ï¼ï¼‰

**ä¼˜åŒ–é…ç½®**ï¼š
```python
import os
import multiprocessing

# è‡ªåŠ¨ä½¿ç”¨CPUæ ¸å¿ƒæ•°
cpu_count = multiprocessing.cpu_count()

# å»ºè®®ä½¿ç”¨ CPUæ ¸å¿ƒæ•° - 1ï¼Œç•™ä¸€ä¸ªæ ¸å¿ƒç»™ç³»ç»Ÿ
optimal_threads = max(2, cpu_count - 1)

# æˆ–è€…ä½¿ç”¨å…¨éƒ¨æ ¸å¿ƒï¼ˆæ¿€è¿›ï¼‰
# optimal_threads = cpu_count
```

---

### æ–¹æ¡ˆ3ï¼šé™ä½åˆ†è¾¨ç‡ â­â­â­â­

**æ€§èƒ½æå‡**ï¼šå·²å®ç°ï¼Œ720pæ¯”1080på¿«56%

**å½“å‰æ”¯æŒ**ï¼š
- âœ… 1080pï¼ˆ1920x1080 / 1080x1920ï¼‰
- âœ… 720pï¼ˆ1280x720 / 720x1280ï¼‰

**å»ºè®®**ï¼šæ·»åŠ æ›´å¤šåˆ†è¾¨ç‡é€‰é¡¹
```python
# 540p - é€‚åˆå¿«é€Ÿé¢„è§ˆ
portrait_540p = "9:16-540p"   # 540x960
landscape_540p = "16:9-540p"  # 960x540

# 480p - æé€Ÿæ¨¡å¼
portrait_480p = "9:16-480p"   # 480x854
landscape_480p = "16:9-480p"  # 854x480
```

---

### æ–¹æ¡ˆ4ï¼šä¼˜åŒ–å­—å¹•æ¸²æŸ“ â­â­â­

**é—®é¢˜**ï¼šè¿½åŠ æ˜¾ç¤ºæ¨¡å¼ä¼šåˆ›å»ºå¤§é‡é‡å¤çš„TextClip

**å½“å‰å®ç°**ï¼š
- ç°ä»£å›¾ä¹¦ï¼šæ¯æ¬¡æ–°å­—å¹•éƒ½é‡æ–°åˆ›å»ºæ‰€æœ‰å†å²è¡Œ
- å¤ä¹¦å·è½´ï¼šæ¯æ¬¡æ–°å­—å¹•éƒ½é‡æ–°åˆ›å»ºæ‰€æœ‰å†å²å­—

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç¼“å­˜æœºåˆ¶
```python
# ç¼“å­˜å·²åˆ›å»ºçš„clipï¼Œé¿å…é‡å¤åˆ›å»º
clip_cache = {}

def get_or_create_text_clip(text, color, ...):
    cache_key = f"{text}_{color}_{font_size}"
    if cache_key not in clip_cache:
        clip_cache[cache_key] = TextClip(...)
    return clip_cache[cache_key]
```

---

### æ–¹æ¡ˆ5ï¼šå…³é—­è§†é¢‘åŠ¨ç”» â­â­â­

**æ€§èƒ½æå‡**ï¼š20-30%åŠ é€Ÿ

**å½“å‰çŠ¶æ€**ï¼šâœ… å·²å®ç°ï¼ˆé»˜è®¤å…³é—­ï¼‰

**é…ç½®**ï¼š
```python
params.enable_video_animation = False  # é»˜è®¤å…³é—­
```

---

### æ–¹æ¡ˆ6ï¼šé™ä½å¸§ç‡ â­â­â­

**æ€§èƒ½æå‡**ï¼šå¸§ç‡é™ä½50%ï¼Œç¼–ç é€Ÿåº¦æå‡çº¦40%

**å½“å‰é…ç½®**ï¼š`fps=30`

**ä¼˜åŒ–é…ç½®**ï¼š
```python
# 24fps - ç”µå½±æ ‡å‡†ï¼Œè§†è§‰æµç•…
fps = 24

# 15fps - å¿«é€Ÿæ¨¡å¼ï¼Œé™æ€å†…å®¹è¶³å¤Ÿ
fps = 15
```

---

### æ–¹æ¡ˆ7ï¼šè°ƒæ•´ç¼–ç å‚æ•° â­â­

**å½“å‰é…ç½®**ï¼š`preset='ultrafast'`ï¼ˆå·²æ˜¯æœ€å¿«ï¼‰

**å¯é€‰ä¼˜åŒ–**ï¼š
```python
# æ–¹æ¡ˆAï¼šä½¿ç”¨æ›´ä½çš„CRFå€¼ï¼ˆæ›´å¿«ä½†è´¨é‡ç¨å·®ï¼‰
ffmpeg_params = [
    '-crf', '28',  # å½“å‰23ï¼Œæé«˜åˆ°28æ›´å¿«ï¼ˆ18-28èŒƒå›´ï¼Œè¶Šå¤§è¶Šå¿«ä½†è´¨é‡è¶Šå·®ï¼‰
    '-preset', 'ultrafast',
    '-tune', 'fastdecode',  # ä¼˜åŒ–è§£ç é€Ÿåº¦
]

# æ–¹æ¡ˆBï¼šå›ºå®šæ¯”ç‰¹ç‡æ¨¡å¼ï¼ˆæ›´ç¨³å®šï¼‰
ffmpeg_params = [
    '-b:v', '3M',  # å›ºå®š3Mbpsæ¯”ç‰¹ç‡
    '-maxrate', '3M',
    '-bufsize', '6M',
    '-preset', 'ultrafast',
]
```

---

### æ–¹æ¡ˆ8ï¼šä½¿ç”¨æ›´å¿«çš„è§†é¢‘ç¼–ç æ ¼å¼ â­â­

**å½“å‰æ ¼å¼**ï¼šH.264ï¼ˆé€šç”¨æ€§å¥½ï¼‰

**æ›´å¿«çš„æ ¼å¼**ï¼š
```python
# VP9 - Googleå¼€å‘ï¼Œç¼–ç æ›´å¿«
video_codec = 'libvpx-vp9'
ffmpeg_params = [
    '-speed', '8',  # é€Ÿåº¦ä¼˜å…ˆï¼ˆ0-8ï¼Œ8æœ€å¿«ï¼‰
    '-tile-columns', '6',
    '-frame-parallel', '1',
    '-threads', str(optimal_threads),
]

# H.265/HEVC - æ›´å¥½çš„å‹ç¼©ç‡ï¼ˆä½†ç¼–ç è¾ƒæ…¢ï¼Œä»…æ¨èç¡¬ä»¶åŠ é€Ÿï¼‰
video_codec = 'libx265'
ffmpeg_params = [
    '-preset', 'ultrafast',
    '-x265-params', 'log-level=error',
]
```

---

### æ–¹æ¡ˆ9ï¼šå‡å°‘å­—å¹•å¤æ‚åº¦ â­â­

**ä¼˜åŒ–ç­–ç•¥**ï¼š
1. å‡å°‘æè¾¹å®½åº¦ï¼š`stroke_width = 1`ï¼ˆå½“å‰1.5ï¼‰
2. ç®€åŒ–å­—ä½“ï¼šä½¿ç”¨ç³»ç»Ÿå­—ä½“è€Œéè‡ªå®šä¹‰å­—ä½“
3. å‡å°‘å­—å¹•é•¿åº¦ï¼šæ¯å¥æ§åˆ¶åœ¨20å­—ä»¥å†…

---

### æ–¹æ¡ˆ10ï¼šå¯ç”¨å¹¶è¡Œå¤„ç† â­â­â­â­

**å½“å‰çŠ¶æ€**ï¼šé¡ºåºå¤„ç†

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```python
from concurrent.futures import ThreadPoolExecutor, ProcessPoolExecutor

# å¹¶è¡Œå¤„ç†å¤šä¸ªè§†é¢‘ç‰‡æ®µ
with ProcessPoolExecutor(max_workers=cpu_count) as executor:
    futures = [executor.submit(process_clip, clip) for clip in clips]
    results = [f.result() for f in futures]
```

---

## ğŸ› ï¸ å®æ–½å»ºè®®

### ç«‹å³å¯ç”¨çš„ä¼˜åŒ–ï¼ˆæ— éœ€ä»£ç ä¿®æ”¹ï¼‰

1. **å¢åŠ çº¿ç¨‹æ•°**
   - åœ¨WebUIä¸­æ·»åŠ çº¿ç¨‹æ•°é…ç½®
   - é»˜è®¤ä½¿ç”¨ `CPUæ ¸å¿ƒæ•° - 1`

2. **ä½¿ç”¨720påˆ†è¾¨ç‡**
   - å·²å®ç°ï¼Œç›´æ¥åœ¨ç•Œé¢é€‰æ‹©

3. **å…³é—­è§†é¢‘åŠ¨ç”»**
   - å·²å®ç°ï¼Œé»˜è®¤å…³é—­

---

### éœ€è¦ä»£ç ä¿®æ”¹çš„ä¼˜åŒ–

#### ä¼˜å…ˆçº§1ï¼šGPUåŠ é€Ÿï¼ˆæ¨èï¼‰

**æ£€æµ‹GPUç±»å‹å¹¶è‡ªåŠ¨é€‰æ‹©ç¼–ç å™¨**ï¼š

```python
def detect_gpu_encoder():
    """è‡ªåŠ¨æ£€æµ‹å¯ç”¨çš„GPUç¼–ç å™¨"""
    import subprocess
    
    try:
        # æ£€æŸ¥ffmpegæ”¯æŒçš„ç¼–ç å™¨
        result = subprocess.run(
            ['ffmpeg', '-hide_banner', '-encoders'],
            capture_output=True,
            text=True
        )
        encoders = result.stdout
        
        # macOS VideoToolbox
        if 'h264_videotoolbox' in encoders:
            return 'h264_videotoolbox', ['-allow_sw', '1']
        
        # NVIDIA NVENC
        if 'h264_nvenc' in encoders:
            return 'h264_nvenc', ['-preset', 'p4']
        
        # AMD AMF
        if 'h264_amf' in encoders:
            return 'h264_amf', ['-quality', 'speed']
        
        # Intel QSV
        if 'h264_qsv' in encoders:
            return 'h264_qsv', ['-preset', 'veryfast']
        
    except:
        pass
    
    # é»˜è®¤ä½¿ç”¨CPUç¼–ç 
    return 'libx264', ['-preset', 'ultrafast']

# ä½¿ç”¨
video_codec, extra_params = detect_gpu_encoder()
```

#### ä¼˜å…ˆçº§2ï¼šä¼˜åŒ–çº¿ç¨‹é…ç½®

```python
import multiprocessing

# åœ¨schema.pyä¸­æ·»åŠ 
class VideoParams(BaseModel):
    n_threads: Optional[int] = None  # Noneè¡¨ç¤ºè‡ªåŠ¨
    
    def get_optimal_threads(self):
        if self.n_threads:
            return self.n_threads
        cpu_count = multiprocessing.cpu_count()
        return max(2, cpu_count - 1)
```

#### ä¼˜å…ˆçº§3ï¼šå­—å¹•ç¼“å­˜

```python
# åœ¨video.pyä¸­æ·»åŠ å…¨å±€ç¼“å­˜
_text_clip_cache = {}

def create_cached_text_clip(text, **kwargs):
    """åˆ›å»ºå¸¦ç¼“å­˜çš„TextClip"""
    cache_key = f"{text}_{kwargs.get('color')}_{kwargs.get('font_size')}"
    if cache_key not in _text_clip_cache:
        _text_clip_cache[cache_key] = TextClip(text=text, **kwargs)
    return _text_clip_cache[cache_key].copy()
```

---

## ğŸ“ˆ é¢„æœŸæ€§èƒ½æå‡

| ä¼˜åŒ–ç»„åˆ | é¢„æœŸåŠ é€Ÿ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|
| **ä»…GPUåŠ é€Ÿ** | 60-80% | æœ‰GPUçš„ç”¨æˆ· |
| **GPU + å¢åŠ çº¿ç¨‹** | 70-90% | æœ‰GPUçš„ç”¨æˆ· |
| **GPU + 720p** | 80-95% | å¿«é€Ÿç”Ÿæˆ |
| **å…¨éƒ¨ä¼˜åŒ–** | 90-95% | æé€Ÿæ¨¡å¼ |

### ç¤ºä¾‹ï¼š60ç§’è§†é¢‘ç”Ÿæˆæ—¶é—´å¯¹æ¯”

| é…ç½® | ç”Ÿæˆæ—¶é—´ | åŠ é€Ÿæ¯” |
|------|---------|-------|
| å½“å‰ï¼ˆ1080p + 2çº¿ç¨‹ + CPUï¼‰ | 90ç§’ | 1x |
| 720p + 2çº¿ç¨‹ + CPU | 50ç§’ | 1.8x |
| 1080p + 8çº¿ç¨‹ + CPU | 60ç§’ | 1.5x |
| **1080p + 8çº¿ç¨‹ + GPU** | **18ç§’** | **5x** âš¡âš¡âš¡ |
| **720p + 8çº¿ç¨‹ + GPU** | **8ç§’** | **11x** âš¡âš¡âš¡âš¡âš¡ |

---

## ğŸ¯ æ¨èå®æ–½é¡ºåº

### ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³å®æ–½ï¼‰
1. âœ… å¢åŠ é»˜è®¤çº¿ç¨‹æ•°åˆ° `CPUæ ¸å¿ƒæ•° - 1`
2. âœ… æ·»åŠ GPUåŠ é€Ÿæ”¯æŒï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
3. âœ… æä¾›å¸§ç‡é€‰é¡¹ï¼ˆ30fps/24fps/15fpsï¼‰

### ç¬¬äºŒé˜¶æ®µï¼ˆä¸­æœŸä¼˜åŒ–ï¼‰
1. å®ç°å­—å¹•ç¼“å­˜æœºåˆ¶
2. æ·»åŠ æ›´å¤šåˆ†è¾¨ç‡é€‰é¡¹ï¼ˆ540pã€480pï¼‰
3. ä¼˜åŒ–è¿½åŠ æ˜¾ç¤ºæ¨¡å¼çš„clipç”Ÿæˆ

### ç¬¬ä¸‰é˜¶æ®µï¼ˆé«˜çº§ä¼˜åŒ–ï¼‰
1. å¹¶è¡Œå¤„ç†å¤šä¸ªè§†é¢‘ç‰‡æ®µ
2. å®ç°é¢„è§ˆæ¨¡å¼ï¼ˆä½è´¨é‡å¿«é€Ÿç”Ÿæˆï¼‰
3. æ·»åŠ ç¡¬ä»¶åŠ é€ŸçŠ¶æ€æ£€æµ‹å’Œæç¤º

---

## ğŸ’» GPUæ”¯æŒæ£€æŸ¥å‘½ä»¤

### æ£€æŸ¥FFmpegæ˜¯å¦æ”¯æŒGPUç¼–ç 

```bash
# æŸ¥çœ‹æ‰€æœ‰ç¼–ç å™¨
ffmpeg -encoders | grep h264

# macOS - æ£€æŸ¥VideoToolbox
ffmpeg -encoders | grep videotoolbox

# NVIDIA - æ£€æŸ¥NVENC
ffmpeg -encoders | grep nvenc

# AMD - æ£€æŸ¥AMF
ffmpeg -encoders | grep amf

# Intel - æ£€æŸ¥QSV
ffmpeg -encoders | grep qsv
```

### å®‰è£…æ”¯æŒGPUçš„FFmpeg

**macOS**ï¼š
```bash
# ä½¿ç”¨Homebrewå®‰è£…ï¼ˆè‡ªåŠ¨åŒ…å«VideoToolboxæ”¯æŒï¼‰
brew install ffmpeg
```

**Windowsï¼ˆNVIDIAï¼‰**ï¼š
```bash
# ä¸‹è½½é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼ˆå·²åŒ…å«NVENCæ”¯æŒï¼‰
# https://www.gyan.dev/ffmpeg/builds/

# æˆ–ä½¿ç”¨condaå®‰è£…
conda install -c conda-forge ffmpeg
```

**Linuxï¼ˆNVIDIAï¼‰**ï¼š
```bash
# å®‰è£…NVIDIAç¼–è§£ç SDK
# https://developer.nvidia.com/nvidia-video-codec-sdk

# ç¼–è¯‘FFmpeg with NVENC support
./configure --enable-nvenc --enable-cuda --enable-cuvid --enable-libnpp
make && make install
```

---

## ğŸ” æ€§èƒ½ç›‘æ§

æ·»åŠ æ€§èƒ½æ—¥å¿—ï¼Œäº†è§£å„ä¸ªé˜¶æ®µçš„è€—æ—¶ï¼š

```python
import time

class PerformanceMonitor:
    def __init__(self):
        self.timings = {}
    
    def start(self, name):
        self.timings[name] = time.time()
    
    def end(self, name):
        if name in self.timings:
            elapsed = time.time() - self.timings[name]
            logger.info(f"â±ï¸ {name}: {elapsed:.2f}s")
            return elapsed
        return 0

# ä½¿ç”¨
pm = PerformanceMonitor()

pm.start("video_processing")
# ... å¤„ç†è§†é¢‘ ...
pm.end("video_processing")

pm.start("subtitle_rendering")
# ... æ¸²æŸ“å­—å¹• ...
pm.end("subtitle_rendering")

pm.start("final_encoding")
# ... æœ€ç»ˆç¼–ç  ...
pm.end("final_encoding")
```

---

## ğŸ“ æ€»ç»“

### æœ€æœ‰æ•ˆçš„ä¼˜åŒ–ï¼ˆæŒ‰æ€§ä»·æ¯”æ’åºï¼‰

1. **GPUåŠ é€Ÿ** - æœ€å¤§æå‡ï¼Œå¼ºçƒˆæ¨è
2. **å¢åŠ çº¿ç¨‹æ•°** - ç®€å•æœ‰æ•ˆ
3. **ä½¿ç”¨720p** - å·²å®ç°ï¼Œæ•ˆæœæ˜¾è‘—
4. **å…³é—­åŠ¨ç”»** - å·²å®ç°
5. **é™ä½å¸§ç‡** - é’ˆå¯¹é™æ€å†…å®¹

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

å»ºè®®ä¼˜å…ˆå®ç°ï¼š
1. GPUè‡ªåŠ¨æ£€æµ‹å’Œå¯ç”¨
2. çº¿ç¨‹æ•°è‡ªåŠ¨ä¼˜åŒ–
3. æ·»åŠ æ€§èƒ½ç›‘æ§æ—¥å¿—

è¿™æ ·å¯ä»¥åœ¨å‡ ä¹ä¸å½±å“è´¨é‡çš„æƒ…å†µä¸‹ï¼Œå°†ç”Ÿæˆé€Ÿåº¦æå‡5-10å€ï¼ğŸš€
